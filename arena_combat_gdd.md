# Arena Combat Prototype
## Game Design Document v0.1

---

# 1. Огляд проєкту

**Назва:** Arena Combat Prototype (робоча)

**Тип:** Third-person melee combat

**Платформа:** PC (Windows/Linux)

**Ціль прототипу:** Відтворити та формалізувати філософію бою з Jedi Academy, Rune, Blade of Darkness — directional fluid combat з low animation commitment.

**Контроли:** Клавіатура + миша

**Мережа:** Передбачити peer-to-peer дуелі

---

# 2. Філософія дизайну

## 2.1. Основний принцип

**"Меч веде руку, не анімація веде гравця."**

У більшості сучасних ігор бій — це state machine: натиснув кнопку → програється анімація → чекаєш її завершення. Гравець "замовляє" дії, а персонаж їх виконує з затримкою.

У нашій системі бій — це **безперервний потік**, де:
- Гравець постійно контролює напрямок і момент удару
- Анімації слугують зворотнім зв'язком, а не обмеженням
- Рух і атака не є взаємовиключними станами

## 2.2. П'ять стовпів бойової системи

### Стовп 1: Directional Input (Напрямковий ввід)

**Що це:** Напрямок удару визначається рухом миші або напрямком руху персонажа в момент атаки.

**Чому важливо:** Це дає гравцю відчуття прямого контролю над зброєю. Не "натисни кнопку для верхнього удару", а "рухай мишу вгору під час атаки".

**Реалізація:**
- 8 базових напрямків удару: верх, низ, ліво, право + 4 діагоналі
- Напрямок зчитується з дельти миші за останні N мілісекунд перед/під час натискання атаки
- Альтернатива: напрямок руху WASD впливає на удар (як у Mount & Blade)
- Комбінація: рух + миша разом модифікують результат

**Нюанси:**
- Занадто чутливо = хаотично, важко контролювати
- Занадто грубо = немає відчуття контролю
- Потрібен "dead zone" для нейтрального удару
- Можливо: візуальний індикатор готового напрямку (subtle, не UI)

### Стовп 2: Fluid Movement (Плавний рух)

**Що це:** Гравець зберігає мобільність під час атаки. Атака не "приковує" до місця.

**Чому важливо:** Це головна різниця з Souls-like. Там commitment до анімації — ключова механіка. У нас свобода руху — ключова механіка.

**Реалізація:**
- Під час атаки швидкість руху знижується, але не до нуля
- Напрямок руху можна змінити mid-swing
- Інерція має значення: удар у русі вперед ≠ удар у русі назад
- Стрибок і перекид доступні майже завжди (з обмеженнями)

**Нюанси:**
- Повна свобода = "танець", де важко попасти (погано для readability)
- Потрібен баланс: ти можеш рухатись, але є "вікна вразливості"
- Швидкість руху під час атаки залежить від типу атаки і зброї

### Стовп 3: Low Animation Commitment (Низьке зобов'язання до анімації)

**Що це:** Більшість дій можна перервати або змінити до певної точки.

**Чому важливо:** Це дає responsive feel. Гра реагує на твій ввід негайно, не "ставить у чергу".

**Реалізація:**
- Кожна атака має фази: wind-up → active → recovery
- Wind-up можна скасувати (feint)
- Active — точка неповернення, але коротка
- Recovery можна скоротити іншою дією (з penalty)

**Система фаз атаки:**
```
[Wind-up: 0-30%] → можна скасувати, можна змінити напрямок
[Active: 30-60%] → не можна скасувати, хітбокс активний
[Recovery: 60-100%] → можна скасувати наступною атакою (combo) або захистом
```

**Нюанси:**
- Якщо все можна скасувати — немає commitment, немає tension
- Потрібна "точка неповернення" для mind games
- Feinting має мати cost (stamina? timing window?)

### Стовп 4: Вага та імпакт (Weight & Impact)

**Що це:** Кожен удар має відчуватися вагомим, мати наслідки.

**Чому важливо:** Без цього fluid combat перетворюється на "розмахування палицями". Це feedback layer.

**Реалізація:**
- Hitstop (freeze frames) при попаданні: 2-4 кадри
- Camera shake (subtle)
- Звуковий дизайн: різний звук для різних попадань
- Knockback/stagger залежить від сили удару і stance противника
- Screen effects (не overtly — subtle chromatic aberration, motion blur)

**Формула імпакту:**
```
Impact = базова_сила_зброї × множник_напрямку × швидкість_руху × stance_penalty
```

**Нюанси:**
- Hitstop уповільнює гру, але дає час "прочитати" що сталось
- Занадто багато screen effects = втомлює
- Звук — найважливіший елемент імпакту

### Стовп 5: Readable Combat (Читабельність бою)

**Що це:** Обидва гравці завжди розуміють що відбувається і чому.

**Чому важливо:** Без цього fluid combat = хаос. Програв і не зрозумів чому = frustration.

**Реалізація:**
- Чіткі силуети атак (навіть для манекенів)
- Anticipation frames: перед ударом є "tell"
- Кольорові/світлові індикатори стану (не UI, а на моделі)
- Траєкторія зброї має бути видимою (motion trail? subtle)
- Звукові cues для wind-up різних атак

**Нюанси:**
- Readable ≠ telegraphed. Не хочемо "жовтий = атака, червоний = сильна атака"
- Readability через анімацію і звук, не через UI overlay
- Гравець має вчитися читати противника, не іконки

---

## 2.3. Чого уникати

### НЕ Souls-like:
- Немає "чекай свою чергу"
- Немає i-frames на перекиді як основна механіка
- Немає stamina як жорсткий rate limiter

### НЕ Hack-and-slash (DMC, Bayonetta):
- Немає combo strings (X, X, X, Y → спецприйом)
- Немає juggling
- Немає style meter

### НЕ Fighting game (Tekken, Soul Calibur):
- Немає frame data як основа балансу (але вона є під капотом)
- Немає складних input sequences (⬇↘➡ + атака)
- Немає arena boundaries як win condition

### НЕ Arkham-style:
- Немає auto-targeting
- Немає counter button з великим вікном
- Немає "flow state" де гра грає за тебе

---

## 2.4. Референси для кожного елемента

| Елемент | Найкращий референс | Чому |
|---------|-------------------|------|
| Directional input | Mount & Blade | Чистота системи |
| Fluid movement | Jedi Academy | Акробатика + бій |
| Animation cancel | Fighting games (загалом) | Точність вікон |
| Impact feel | Blade of Darkness | Dismemberment, вага |
| Readability | Rune | Чіткі силуети |

---

# 3. Механіки

## 3.1. Система атаки

### Базові атаки

**Light Attack (ЛКМ):**
- Швидкий удар
- Напрямок = дельта миші
- Низький damage, швидкий recovery
- Можна chaining (до 3 ударів)

**Heavy Attack (ЛКМ hold → release):**
- Заряджається під час утримання
- Напрямок фіксується при release
- Високий damage, довгий recovery
- Не можна chain

**Thrust/Stab (ЛКМ + forward movement):**
- Колючий удар вперед
- Вужчий хітбокс, більша дистанція
- Ігнорує частину армору (якщо буде система армору)

### Напрямки атаки

```
    [Верх-ліво]     [Верх]      [Верх-право]
           ↖          ↑          ↗
             \        |        /
    [Ліво] ← ────[Центр]──── → [Право]
             /        |        \
           ↙          ↓          ↘
   [Низ-ліво]      [Низ]       [Низ-право]
```

**Як визначається напрямок:**

1. Зчитується дельта миші за останні 100ms
2. Якщо дельта < threshold → центральний удар (thrust)
3. Якщо дельта > threshold → напрямок визначається вектором
4. Модифікатор від WASD (опційно): рух вбік підсилює горизонтальний удар

### Combo система

**Принцип:** Наступний удар у chain швидший, але передбачуваніший.

```
Удар 1: повний wind-up, всі напрямки доступні
Удар 2: скорочений wind-up, обмежені напрямки (продовження траєкторії)
Удар 3: мінімальний wind-up, лише один напрямок
```

**Chain logic:**
- Удар зліва → наступний природно йде справа (або вниз-зліва)
- Можна "зламати" chain свідомо, але це повільніше
- Combo = читабельність для противника (trade-off)

---

## 3.2. Система захисту

### Block (ПКМ hold)

**Механіка:**
- Утримання = активний блок у напрямку погляду/миші
- Блок має напрямок (як атака)
- Успішний блок = напрямок блоку ≈ напрямок атаки (±45°)

**Directional blocking:**
```
Атака зверху → блок угору = повний блок
Атака зверху → блок збоку = partial block (менше damage reduction)
Атака зверху → блок внизу = пробитий блок (повний damage)
```

**Stamina cost:**
- Блок витрачає stamina
- Пробитий блок = більше stamina damage
- Perfect block (timing) = мінімум stamina cost

### Parry (ПКМ tap at right moment)

**Механіка:**
- Натискання ПКМ у вікні 100-200ms перед ударом
- Успішний parry = противник у stagger
- Ризик: поза вікном = ти відкритий

**Parry window:**
```
[Атака противника]
   ↓
[...] [PARRY WINDOW: 150ms] [IMPACT]
```

**Directional parry (advanced):**
- Parry у правильному напрямку = довший stagger
- Parry у неправильному = коротший stagger, частковий damage

### Dodge/Sidestep (Space/Shift + direction)

**Механіка:**
- Швидкий крок у напрямку
- НЕ має i-frames (або дуже короткі, 50ms)
- Головна функція — repositioning, не "безкоштовна втеча"

**Stamina cost:**
- Значна витрата
- Не можна спамити

---

## 3.3. Система руху

### Базовий рух

**Walking (WASD):**
- Повна швидкість, повний контроль
- Завжди доступний (навіть mid-attack, зі штрафом)

**Sprinting (Shift + W):**
- Збільшена швидкість
- Не можна атакувати (потрібен перехід)
- Витрачає stamina

### Спеціальний рух

**Jump (Space):**
- Базовий стрибок
- Можна атакувати у повітрі (air attack)
- Landing має recovery frames

**Roll (Space + direction while moving):**
- Перекид
- Короткі i-frames на початку (50-100ms)
- Довгий recovery
- Високий stamina cost

**Sidestep (Tap direction × 2):**
- Швидкий крок убік
- Немає i-frames
- Низький stamina cost
- Можна зробити з блоку

### Рух під час атаки

**Принцип:** Швидкість руху під час атаки = 30-50% від базової

**Модифікатори:**
- Light attack: 50% movement speed
- Heavy attack: 30% movement speed
- Thrust: 70% movement speed (forward only)
- Recovery: 80% movement speed

---

## 3.4. Stamina система

### Філософія

**НЕ як у Dark Souls:** Stamina не є жорстким лімітом, який забороняє дії.

**Як у нас:** Stamina — це "ресурс переваги". Можна діяти з низькою stamina, але з penalties.

### Витрати

| Дія | Stamina cost |
|-----|--------------|
| Light attack | 10 |
| Heavy attack | 25 |
| Block (per hit) | 15 |
| Perfect parry | 5 |
| Failed parry | 30 |
| Dodge | 20 |
| Roll | 35 |
| Sprint (per second) | 5 |

### Regeneration

- Базова регенерація: 15/сек
- Під час блоку: 5/сек
- Після отримання удару: пауза 1 сек
- Максимум: 100

### Low Stamina Penalties

```
Stamina > 50%: норма
Stamina 25-50%: wind-up +20%, movement -10%
Stamina < 25%: wind-up +40%, movement -20%, no parry
Stamina = 0: forced recovery state (2 sec), vulnerable
```

---

## 3.5. Система пошкоджень

### Health

- Базове здоров'я: 100
- Немає регенерації (для прототипу арени)
- Можливо: armor як окремий шар (майбутнє)

### Damage calculation

```
Final_Damage = Base_Damage × Direction_Modifier × Momentum × Block_Reduction × Armor

Де:
- Base_Damage: статична величина зброї
- Direction_Modifier: 0.8 - 1.2 залежно від напрямку і stance
- Momentum: 0.8 - 1.3 залежно від руху атакуючого
- Block_Reduction: 0 (не блок) / 0.3 (partial) / 0.7 (full) / 1.0 (perfect)
- Armor: майбутня система
```

### Stagger / Hitstun

**При отриманні удару:**
- Light hit: stagger 200ms (можна блокувати)
- Heavy hit: stagger 400ms (не можна блокувати)
- Counter hit (mid-attack): stagger 600ms

**Stagger = вікно для follow-up, але не guaranteed combo**

### Dismemberment (візуальне, для відчуття)

**Для прототипу:** можливо спрощена версія — візуальні "порізи" на манекені без фактичного відділення частин.

**Майбутнє:** система локального damage (рука пошкоджена = повільніші атаки з того боку).

---

# 4. Контроли

## 4.1. Keyboard + Mouse Layout

### Основні

| Ввід | Дія |
|------|-----|
| W/A/S/D | Рух |
| Mouse movement | Камера + напрямок атаки |
| ЛКМ | Light attack |
| ЛКМ (hold) | Charge heavy attack |
| ПКМ | Block |
| ПКМ (tap) | Parry (timing-based) |
| Space | Jump / Roll (з напрямком) |
| Shift | Sprint |
| Shift + direction (tap) | Sidestep |

### Додаткові (для прототипу)

| Ввід | Дія |
|------|-----|
| R | Reset position (debug) |
| F | Switch stance (якщо буде система) |
| Tab | Scoreboard (multiplayer) |
| Esc | Menu |

## 4.2. Принципи input системи

**Input buffer:** 
- Команди буферизуються на 100-150ms
- Запобігає "ковтанню" інпутів
- Але не queue система (тільки остання команда)

**Mouse sensitivity:**
- Для напрямку атаки: окрема sensitivity від камери
- Можливо: acceleration curve для "вловлювання" свайпів

**Input priority:**
```
1. Parry (якщо в parry window)
2. Block (якщо утримується)
3. Attack (якщо натиснуто)
4. Movement (завжди)
```

---

# 5. Мережа

## 5.1. Архітектура

**Модель:** Peer-to-peer для прототипу (простіше)

**Майбутнє:** Dedicated server для турнірів

## 5.2. Netcode підхід

### Rollback netcode (рекомендовано)

**Чому:** 
- Fluid combat потребує responsive input
- Delay-based netcode вбиває відчуття контролю
- Rollback дозволяє "локальний" feel навіть з latency

**Принцип:**
1. Локальна симуляція виконується миттєво
2. Отримано input від противника → rollback до того кадру → re-simulate
3. Візуально маскується інтерполяцією

### Що синхронізується

- Position + rotation
- Current action state
- Stamina
- Health
- Input events (з timestamp)

### Що предиктується локально

- Власний рух
- Власні атаки
- Позиція противника (dead reckoning)

### Що коректується

- Hit registration (server-authoritative для ranked, взаємне підтвердження для casual)
- Damage application

## 5.3. Проблеми для вирішення

**Trading hits:**
- Обидва гравці бачать свій удар першим
- Рішення: обидва удари реєструються якщо в overlap window

**Phantom hits:**
- Локально попав, на сервері — ні
- Рішення: візуальний feedback (часткові іскри?) навіть для rolled-back hits

**Teleporting:**
- При великому lag — противник "телепортується"
- Рішення: aggressive interpolation + velocity prediction

---

# 6. Арена (прототип)

## 6.1. Простір

**Форма:** Кругла арена, діаметр ~30 метрів

**Підлога:** Плоска, без перешкод (для прототипу)

**Межі:** Невидима стіна або ledge (падіння = respawn)

## 6.2. Lighting

- Яскраве, рівномірне освітлення
- Чіткі тіні для читабельності силуетів
- Нейтральний фон (не відволікає)

## 6.3. Візуальні елементи (мінімум)

- Floor grid (для відчуття руху)
- Subtle ambient particles (dust)
- Skybox (нейтральний)

---

# 7. Манекени (персонажі прототипу)

## 7.1. Візуальний дизайн

**Стиль:** Anatomical mannequin (дерев'яний манекен художника)

**Чому:**
- Немає потреби в текстурах
- Чіткий силует
- Суглоби видно = readable poses
- Нейтральний, не відволікає від механік

**Деталі:**
- Сферичні суглоби
- Циліндричні кінцівки
- Овальний торс
- Голова без рис обличчя
- Різні кольори для P1 / P2 (синій / помаранчевий)

## 7.2. Зброя (прототип)

**Для початку — одна зброя:** пряма одноручна зброя (longsword silhouette)

**Характеристики:**
- Довжина: середня
- Швидкість: середня
- Damage: середній
- Усі механіки доступні

**Майбутнє:** різні типи зброї з різними характеристиками

---

# 8. Майбутні системи (поза прототипом)

Ці системи НЕ входять у прототип, але архітектура має їх передбачити:

## 8.1. Система зброї

- Різні типи: мечі, сокири, списи, дворучна
- Кожна зброя: унікальний moveset, reach, speed, damage
- Trade-offs між категоріями

## 8.2. Система стійок (Stances)

- 2-3 стійки на зброю
- Різний набір атак і властивостей
- Switching має cost/timing

## 8.3. Система персонажів

- Різні статури (швидший vs міцніший)
- Можливо: abilities (не магія, а прийоми)

## 8.4. Режими гри

- Duel (1v1)
- Brawl (FFA)
- Team battle
- Tournament

## 8.5. Progression (якщо потрібно)

- Cosmetics only
- Можливо: unlockable weapons (з балансом)
- Ranked ladder

---

# 9. Метрики успіху прототипу

## 9.1. Feel-тест

**Питання для playtesting:**
1. Чи відчувається контроль над напрямком удару?
2. Чи можна рухатись під час бою без frustration?
3. Чи читаються атаки противника?
4. Чи є "вага" у ударах?
5. Чи цікаві mind games (feint, timing)?

## 9.2. Технічні метрики

- Input latency < 50ms (локально)
- Netcode latency compensation до 150ms
- Стабільні 60 FPS мінімум
- Hit registration accuracy > 95%

## 9.3. Поведінкові метрики

- Середня тривалість раунду: 30-90 секунд
- Співвідношення атак/блоків: ~60/40
- Successful parry rate: 10-20% (має бути ризиковано)
- Використання всіх напрямків атаки (не лише один)

---

# 10. Технічний стек (рекомендації)

## 10.1. Мова

**Рекомендація:** Rust або C++

**Rust:**
- Memory safety без GC
- Хороші мережеві бібліотеки
- Крутий для rollback netcode

**C++:**
- Традиційний вибір для ігор
- Більше ресурсів/туторіалів
- Простіша інтеграція з існуючими рішеннями

## 10.2. Рендеринг

**Рекомендація для прототипу:** 
- Raylib (простий, кросплатформний)
- Або wgpu/Vulkan якщо хочеться low-level

## 10.3. Фізика

**Рекомендація:** власна спрощена система

**Чому:** 
- Box2D/Bullet — overkill для меле
- Потрібні специфічні хітбокси для зброї
- Sweep tests для швидких атак

## 10.4. Мережа

**Рекомендація:** 
- GGPO-style rollback (є open source реалізації)
- ENet для transport layer

---

# 11. Етапи розробки

## Phase 1: Core Movement
- [ ] Базовий рух (WASD)
- [ ] Камера (mouse look)
- [ ] Sprint, jump
- [ ] Манекен рендер

## Phase 2: Basic Combat
- [ ] Light attack з directional input
- [ ] Hit detection (sword hitbox)
- [ ] Базовий damage і stagger
- [ ] Block (static)

## Phase 3: Advanced Combat
- [ ] Directional block
- [ ] Parry system
- [ ] Heavy attack (charge)
- [ ] Stamina system

## Phase 4: Polish
- [ ] Animation blending
- [ ] Hitstop, camera shake
- [ ] Sound effects
- [ ] Visual feedback (trails, particles)

## Phase 5: Multiplayer
- [ ] Basic netcode (delay-based для тесту)
- [ ] Rollback implementation
- [ ] Lobby system
- [ ] Hit registration sync

## Phase 6: Iteration
- [ ] Playtesting
- [ ] Balance tuning
- [ ] Feel adjustments
- [ ] Bug fixing

---

# Додаток A: Глосарій

| Термін | Визначення |
|--------|------------|
| Wind-up | Фаза підготовки до удару |
| Active frames | Кадри, коли хітбокс активний |
| Recovery | Фаза після удару, коли персонаж вразливий |
| Stagger | Стан, коли персонаж не може діяти після отримання удару |
| Hitstop | Коротка пауза при попаданні для імпакту |
| Feint | Скасування атаки для обману противника |
| i-frames | Кадри невразливості |
| Commitment | Неможливість скасувати дію |
| Rollback | Техніка netcode для компенсації latency |
| Trade | Обопільний удар |

---

# Додаток B: Формули

## B.1. Direction Detection

```
direction = atan2(mouse_delta.y, mouse_delta.x)
quadrant = round(direction / (π/4)) % 8
if magnitude(mouse_delta) < threshold:
    quadrant = CENTER (thrust)
```

## B.2. Damage Formula

```
damage = base_damage 
       × direction_mod(attacker_dir, defender_stance)
       × momentum_mod(attacker_velocity)
       × (1 - block_reduction)
       × (1 - armor_reduction)
```

## B.3. Stamina Regeneration

```
if time_since_hit > 1.0:
    if blocking:
        stamina += 5 × delta_time
    else:
        stamina += 15 × delta_time
stamina = clamp(stamina, 0, 100)
```

---

*Документ буде оновлюватись у процесі розробки.*

*Версія: 0.1*
*Дата: [поточна дата]*
