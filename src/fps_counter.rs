/*
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
 ะคะะะ: src/fps_counter.rs
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

๐ ะะะะะะะงะะะะฏ:
   FpsCounter - ะฟัะพััะธะน ะปััะธะปัะฝะธะบ FPS (frames per second).

   ะัะดัะฐัะพะฒัั ัะบัะปัะบะธ ะบะฐะดััะฒ ัะตะฝะดะตัะธัััั ะทะฐ ัะตะบัะฝะดั ัะฐ ะฝะฐะดะฐั ัะต ะทะฝะฐัะตะฝะฝั
   ะดะปั ะฒัะดะพะฑัะฐะถะตะฝะฝั ะฒ ะทะฐะณะพะปะพะฒะบั ะฒัะบะฝะฐ ะฐะฑะพ UI.

๐ฏ ะะะะะะะะะะะฌะะะกะขะฌ:
   - ะัะดัะฐััะฝะพะบ FPS ะฝะฐ ะพัะฝะพะฒั ัะฐัั ะผัะถ ะบะฐะดัะฐะผะธ
   - ะะฑะตัะตะถะตะฝะฝั ัััะพััั ะดะปั ะทะณะปะฐะดะถะตะฝะพะณะพ (averaged) FPS
   - ะะฐะดะฐะฝะฝั ะฟะพัะพัะฝะพะณะพ FPS ะทะฝะฐัะตะฝะฝั

๐ ะะ'ะฏะะะ ะ ะะะจะะะ ะคะะะะะะ:
   ะะผะฟะพัััั:
   - std::time::Instant - ะดะปั ะฒะธะผัััะฒะฐะฝะฝั ัะฐัั

   ะะบัะฟะพัััั ะดะปั:
   - main.rs - ะฒัะดะพะฑัะฐะถะตะฝะฝั FPS ะฒ ะทะฐะณะพะปะพะฒะบั ะฒัะบะฝะฐ

๐ฆ ะะะะะะะะกะขะ:
   - ะะตะผะฐั ะทะพะฒะฝััะฝัั (ััะปัะบะธ std)

โ๏ธ  ะะะะะะะ ะะะะะะะะะฏ:
   1. ะฆะต ะะ ะดะตัะตัะผัะฝะพะฒะฐะฝะฐ ะปะพะณัะบะฐ (ะฒะธะบะพัะธััะพะฒัั system time)
   2. FPS counter ะะ ะฒะฟะปะธะฒะฐั ะฝะฐ game logic
   3. ะขัะปัะบะธ ะดะปั ะฒัะดะพะฑัะฐะถะตะฝะฝั, ะฝะต ะดะปั ะบะพะฝััะพะปั frame rate

๐งช ะขะะกะขะฃะะะะะฏ:
   ```rust
   let mut fps = FpsCounter::new();

   loop {
       fps.tick();
       let current_fps = fps.fps();
       println!("FPS: {:.1}", current_fps);
   }
   ```

๐ ะะกะขะะะะฏ:
   2025-12-14: ะกัะฒะพัะตะฝะพ - ะฑะฐะทะพะฒะธะน FPS counter ะท ััะตัะตะดะฝะตะฝะฝัะผ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
*/

use std::time::Instant;

/// FPS Counter - ะฟัะดัะฐัะพะฒัั frames per second
///
/// ะะธะบะพัะธััะพะฒัั ะบะพะฒะทะฝะต ะฒัะบะฝะพ ะดะปั ะทะณะปะฐะดะถัะฒะฐะฝะฝั ะทะฝะฐัะตะฝั FPS
pub struct FpsCounter {
    /// ะงะฐั ะพััะฐะฝะฝัะพะณะพ ะบะฐะดัั
    last_frame_time: Instant,

    /// ะััะพััั ัะฐัั ะผัะถ ะบะฐะดัะฐะผะธ (ะดะปั ััะตัะตะดะฝะตะฝะฝั)
    frame_times: Vec<f32>,

    /// ะะฐะบัะธะผะฐะปัะฝะธะน ัะพะทะผัั ัััะพััั
    max_samples: usize,

    /// ะะพัะพัะฝะธะน ัะฝะดะตะบั ะฒ circular buffer
    current_index: usize,

    /// ะะพัะพัะฝะต ะทะฝะฐัะตะฝะฝั FPS
    current_fps: f32,
}

impl FpsCounter {
    /// ะกัะฒะพััั ะฝะพะฒะธะน FPS counter
    ///
    /// # ะัะณัะผะตะฝัะธ
    /// * `samples` - ะบัะปัะบัััั ะบะฐะดััะฒ ะดะปั ััะตัะตะดะฝะตะฝะฝั (ะทะฐ ะทะฐะผะพะฒััะฒะฐะฝะฝัะผ 60)
    ///
    /// # ะะพะฒะตััะฐั
    /// ะะพะฒะธะน FpsCounter
    pub fn new() -> Self {
        Self::with_samples(60)
    }

    /// ะกัะฒะพััั FPS counter ะท ะทะฐะดะฐะฝะพั ะบัะปัะบัััั ัะตะผะฟะปัะฒ ะดะปั ััะตัะตะดะฝะตะฝะฝั
    ///
    /// # ะัะณัะผะตะฝัะธ
    /// * `samples` - ะบัะปัะบัััั ะบะฐะดััะฒ ะดะปั ััะตัะตะดะฝะตะฝะฝั
    pub fn with_samples(samples: usize) -> Self {
        Self {
            last_frame_time: Instant::now(),
            frame_times: vec![0.016; samples], // ~60 FPS ะทะฐ ะทะฐะผะพะฒััะฒะฐะฝะฝัะผ
            max_samples: samples,
            current_index: 0,
            current_fps: 60.0,
        }
    }

    /// ะะธะบะปะธะบะฐััััั ะพะดะธะฝ ัะฐะท ะฝะฐ ะบะฐะดั ะดะปั ะพะฝะพะฒะปะตะฝะฝั FPS
    ///
    /// ะัะดัะฐัะพะฒัั ัะฐั ะท ะพััะฐะฝะฝัะพะณะพ ะบะฐะดัั ั ะพะฝะพะฒะปัั FPS
    pub fn tick(&mut self) {
        let now = Instant::now();
        let delta = now.duration_since(self.last_frame_time).as_secs_f32();
        self.last_frame_time = now;

        // ะะพะดะฐัะธ ะฝะพะฒะธะน frame time ะฒ circular buffer
        self.frame_times[self.current_index] = delta;
        self.current_index = (self.current_index + 1) % self.max_samples;

        // ะะฑัะธัะปะธัะธ ัะตัะตะดะฝัะน FPS
        let avg_frame_time: f32 = self.frame_times.iter().sum::<f32>() / self.max_samples as f32;

        // FPS = 1 / frame_time
        if avg_frame_time > 0.0 {
            self.current_fps = 1.0 / avg_frame_time;
        }
    }

    /// ะะพะฒะตััะฐั ะฟะพัะพัะฝะต ะทะฝะฐัะตะฝะฝั FPS
    ///
    /// # ะะพะฒะตััะฐั
    /// ะฃัะตัะตะดะฝะตะฝะต ะทะฝะฐัะตะฝะฝั FPS ะทะฐ ะพััะฐะฝะฝั N ะบะฐะดััะฒ
    pub fn fps(&self) -> f32 {
        self.current_fps
    }

    /// ะะพะฒะตััะฐั ะฟะพัะพัะฝะธะน frame time (ัะฐั ะฝะฐ ะพะดะธะฝ ะบะฐะดั) ะฒ ะผัะปััะตะบัะฝะดะฐั
    ///
    /// # ะะพะฒะตััะฐั
    /// ะงะฐั ะฝะฐ ะบะฐะดั ะฒ ะผั
    pub fn frame_time_ms(&self) -> f32 {
        if self.current_fps > 0.0 {
            1000.0 / self.current_fps
        } else {
            0.0
        }
    }
}

impl Default for FpsCounter {
    fn default() -> Self {
        Self::new()
    }
}
