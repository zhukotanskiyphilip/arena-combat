/*
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 Ð¤ÐÐ™Ð›: src/time/game_time.rs
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“‹ ÐŸÐ Ð˜Ð—ÐÐÐ§Ð•ÐÐÐ¯:
   GameTime - tracking Ñ‡Ð°ÑÑƒ Ð´Ð»Ñ game loop.

ðŸŽ¯ Ð’Ð†Ð”ÐŸÐžÐ’Ð†Ð”ÐÐ›Ð¬ÐÐ†Ð¡Ð¢Ð¬:
   - Delta time (Ñ‡Ð°Ñ Ð¼Ñ–Ð¶ ÐºÐ°Ð´Ñ€Ð°Ð¼Ð¸)
   - Total elapsed time
   - Frame counting

âš ï¸  Ð’ÐÐ–Ð›Ð˜Ð’Ð† Ð”Ð•Ð¢ÐÐ›Ð†:
   - Delta time Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ… (f32)
   - Clamped Ð´Ð¾ max 0.1s Ð´Ð»Ñ ÑƒÐ½Ð¸ÐºÐ½ÐµÐ½Ð½Ñ physics explosions
   - Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ” std::time::Instant Ð´Ð»Ñ Ñ‚Ð¾Ñ‡Ð½Ð¾ÑÑ‚Ñ–

ðŸ• Ð†Ð¡Ð¢ÐžÐ Ð†Ð¯:
   2025-12-14: Ð¡Ñ‚Ð²Ð¾Ñ€ÐµÐ½Ð¾ - Ð±Ð°Ð·Ð¾Ð²Ð¸Ð¹ delta time tracking

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
*/

use std::time::Instant;

/// GameTime - ÑƒÐ¿Ñ€Ð°Ð²Ð»Ñ–Ð½Ð½Ñ Ñ‡Ð°ÑÐ¾Ð¼ Ð² Ð³Ñ€Ñ–
///
/// Ð’Ñ–Ð´ÑÑ‚ÐµÐ¶ÑƒÑ” delta time (Ñ‡Ð°Ñ Ð¼Ñ–Ð¶ ÐºÐ°Ð´Ñ€Ð°Ð¼Ð¸) Ñ‚Ð° Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ñ‡Ð°Ñ.
/// Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑ”Ñ‚ÑŒÑÑ Ð´Ð»Ñ frame-rate independent Ð°Ð½Ñ–Ð¼Ð°Ñ†Ñ–Ð¹ Ñ‚Ð° physics.
pub struct GameTime {
    /// Ð§Ð°Ñ Ð¾ÑÑ‚Ð°Ð½Ð½ÑŒÐ¾Ð³Ð¾ ÐºÐ°Ð´Ñ€Ñƒ
    last_frame: Instant,

    /// Delta time Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ… (Ñ‡Ð°Ñ Ð· Ð¾ÑÑ‚Ð°Ð½Ð½ÑŒÐ¾Ð³Ð¾ ÐºÐ°Ð´Ñ€Ñƒ)
    delta_time: f32,

    /// Ð—Ð°Ð³Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ñ‡Ð°Ñ Ð· Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð³Ñ€Ð¸ Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…
    total_time: f32,

    /// Ð›Ñ–Ñ‡Ð¸Ð»ÑŒÐ½Ð¸Ðº ÐºÐ°Ð´Ñ€Ñ–Ð²
    frame_count: u64,
}

impl GameTime {
    /// Ð¡Ñ‚Ð²Ð¾Ñ€ÑŽÑ” Ð½Ð¾Ð²Ð¸Ð¹ GameTime
    pub fn new() -> Self {
        Self {
            last_frame: Instant::now(),
            delta_time: 0.0,
            total_time: 0.0,
            frame_count: 0,
        }
    }

    /// ÐžÐ½Ð¾Ð²Ð»ÑŽÑ” Ñ‡Ð°Ñ (Ð²Ð¸ÐºÐ»Ð¸ÐºÐ°Ñ‚Ð¸ Ð½Ð° Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ ÐºÐ¾Ð¶Ð½Ð¾Ð³Ð¾ ÐºÐ°Ð´Ñ€Ñƒ)
    ///
    /// ÐžÐ±Ñ‡Ð¸ÑÐ»ÑŽÑ” delta time Ñ‚Ð° Ð¾Ð½Ð¾Ð²Ð»ÑŽÑ” total time.
    /// Delta time Ð¾Ð±Ð¼ÐµÐ¶ÐµÐ½Ð¸Ð¹ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼Ð¾Ð¼ 0.1s (100ms) Ñ‰Ð¾Ð± ÑƒÐ½Ð¸ÐºÐ½ÑƒÑ‚Ð¸
    /// physics explosions Ð¿Ñ€Ð¸ Ð²ÐµÐ»Ð¸ÐºÐ¸Ñ… Ð»Ð°Ð³Ð°Ñ….
    pub fn update(&mut self) {
        let now = Instant::now();
        let elapsed = now.duration_since(self.last_frame);

        // ÐšÐ¾Ð½Ð²ÐµÑ€Ñ‚ÑƒÑ”Ð¼Ð¾ Ð² ÑÐµÐºÑƒÐ½Ð´Ð¸
        let raw_delta = elapsed.as_secs_f32();

        // Clamp delta time Ð´Ð¾ Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼Ñƒ 100ms
        // Ð¦Ðµ Ð²Ð°Ð¶Ð»Ð¸Ð²Ð¾ Ð´Ð»Ñ ÑƒÐ½Ð¸ÐºÐ½ÐµÐ½Ð½Ñ physics explosions Ð¿Ñ€Ð¸ Ð»Ð°Ð³Ð°Ñ…
        self.delta_time = raw_delta.min(0.1);

        // ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ total time
        self.total_time += self.delta_time;

        // ÐžÐ½Ð¾Ð²Ð»ÑŽÑ”Ð¼Ð¾ frame count
        self.frame_count += 1;

        // Ð—Ð±ÐµÑ€Ñ–Ð³Ð°Ñ”Ð¼Ð¾ Ñ‡Ð°Ñ Ñ†ÑŒÐ¾Ð³Ð¾ ÐºÐ°Ð´Ñ€Ñƒ
        self.last_frame = now;
    }

    /// ÐŸÐ¾Ð²ÐµÑ€Ñ‚Ð°Ñ” delta time Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…
    ///
    /// Ð¦Ðµ Ñ‡Ð°Ñ Ð· Ð¿Ð¾Ð¿ÐµÑ€ÐµÐ´Ð½ÑŒÐ¾Ð³Ð¾ ÐºÐ°Ð´Ñ€Ñƒ. Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹Ñ‚Ðµ Ð´Ð»Ñ
    /// frame-rate independent Ñ€ÑƒÑ…Ñƒ Ñ‚Ð° Ð°Ð½Ñ–Ð¼Ð°Ñ†Ñ–Ð¹.
    ///
    /// # ÐŸÑ€Ð¸ÐºÐ»Ð°Ð´
    /// ```
    /// // Ð ÑƒÑ… Ð·Ñ– ÑˆÐ²Ð¸Ð´ÐºÑ–ÑÑ‚ÑŽ 5 units/second
    /// let speed = 5.0;
    /// position += velocity * speed * game_time.delta();
    /// ```
    #[inline]
    pub fn delta(&self) -> f32 {
        self.delta_time
    }

    /// ÐŸÐ¾Ð²ÐµÑ€Ñ‚Ð°Ñ” Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ð¸Ð¹ Ñ‡Ð°Ñ Ð· Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð³Ñ€Ð¸ Ð² ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…
    ///
    /// ÐšÐ¾Ñ€Ð¸ÑÐ½Ð¾ Ð´Ð»Ñ shader effects, Ð°Ð½Ñ–Ð¼Ð°Ñ†Ñ–Ð¹ Ñ‚Ð¾Ñ‰Ð¾.
    #[inline]
    pub fn total(&self) -> f32 {
        self.total_time
    }

    /// ÐŸÐ¾Ð²ÐµÑ€Ñ‚Ð°Ñ” ÐºÑ–Ð»ÑŒÐºÑ–ÑÑ‚ÑŒ ÐºÐ°Ð´Ñ€Ñ–Ð² Ð· Ð¿Ð¾Ñ‡Ð°Ñ‚ÐºÑƒ Ð³Ñ€Ð¸
    #[inline]
    pub fn frame_count(&self) -> u64 {
        self.frame_count
    }

    /// ÐŸÐ¾Ð²ÐµÑ€Ñ‚Ð°Ñ” delta time Ð² Ð¼Ñ–Ð»Ñ–ÑÐµÐºÑƒÐ½Ð´Ð°Ñ…
    #[inline]
    pub fn delta_ms(&self) -> f32 {
        self.delta_time * 1000.0
    }
}

impl Default for GameTime {
    fn default() -> Self {
        Self::new()
    }
}
