# Ğ¢ĞµÑ…Ğ½Ñ–Ñ‡Ğ½Ğ¸Ğ¹ ÑÑ‚ĞµĞº Arena Combat
## Ğ Ñ–ÑˆĞµĞ½Ğ½Ñ Ñ‰Ğ¾Ğ´Ğ¾ Ğ¼Ğ¾Ğ²Ğ¸ Ğ¿Ñ€Ğ¾Ğ³Ñ€Ğ°Ğ¼ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ñ‚Ğ° Ğ°Ñ€Ñ…Ñ–Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ¸

---

## ĞŸÑ–Ğ´ÑÑƒĞ¼Ğ¾Ğº Ñ€ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´Ğ°Ñ†Ñ–Ğ¹

### âœ… **ĞĞ±Ñ€Ğ°Ğ½Ğ° Ğ¼Ğ¾Ğ²Ğ°: Rust**
### âœ… **ĞÑ€Ñ…Ñ–Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ°: P2P Rollback Netcode**
### âœ… **Engine: Bevy (ECS)**

---

## 1. ĞĞ±Ò‘Ñ€ÑƒĞ½Ñ‚ÑƒĞ²Ğ°Ğ½Ğ½Ñ Ğ²Ğ¸Ğ±Ğ¾Ñ€Ñƒ Rust

### ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ñ– Ğ¿ĞµÑ€ĞµĞ²Ğ°Ğ³Ğ¸ Ğ´Ğ»Ñ Arena Combat:

#### 1.1. Rollback Netcode - Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğµ Ñ€Ñ–ÑˆĞµĞ½Ğ½Ñ
Ğ’Ğ°ÑˆĞ° Ğ³Ñ€Ğ° **Ğ’Ğ˜ĞœĞĞ“ĞĞ„** rollback Ñ‡ĞµÑ€ĞµĞ· fluid combat Ñ„Ñ–Ğ»Ğ¾ÑĞ¾Ñ„Ñ–Ñ. Ğ£ Rust Ñ” **Ğ½Ğ°Ğ¹ĞºÑ€Ğ°Ñ‰Ğ° open-source Ñ€ĞµĞ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ** rollback netcode.

**Ğ‘Ñ–Ğ±Ğ»Ñ–Ğ¾Ñ‚ĞµĞºĞ° GGRS:**
- Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Ğ² production fighting games
- ĞŸĞ¾Ğ²Ğ½Ğ° Ñ–Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ñ–Ñ Ğ· Bevy
- ĞŸÑ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ĞºĞ° Ğ´Ğ¾ 8 Ğ³Ñ€Ğ°Ğ²Ñ†Ñ–Ğ² (Ğ´Ğ»Ñ Ğ¼Ğ°Ğ¹Ğ±ÑƒÑ‚Ğ½ÑŒĞ¾Ğ³Ğ¾)
- Spectator mode Ğ²Ğ±ÑƒĞ´Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
- Battle-tested

**ĞĞ»ÑŒÑ‚ĞµÑ€Ğ½Ğ°Ñ‚Ğ¸Ğ²Ğ¸ Ğ² Ñ–Ğ½ÑˆĞ¸Ñ… Ğ¼Ğ¾Ğ²Ğ°Ñ…:**
- C++: GGPO (ÑÑ‚Ğ°Ñ€Ñ–ÑˆĞ°, Ğ¼ĞµĞ½Ñˆ Ğ¿Ñ–Ğ´Ñ‚Ñ€Ğ¸Ğ¼ÑƒĞ²Ğ°Ğ½Ğ°)
- Ğ†Ğ½ÑˆÑ– Ğ¼Ğ¾Ğ²Ğ¸: Ğ½Ñ–Ñ‡Ğ¾Ğ³Ğ¾ production-ready

#### 1.2. Ğ”ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ñ–Ğ·Ğ¼ Ğ·Ğ° Ğ´Ğ¸Ğ·Ğ°Ğ¹Ğ½Ğ¾Ğ¼
Rust Ğ·Ğ¼ÑƒÑˆÑƒÑ” Ğ²Ğ°Ñ Ğ¿Ğ¸ÑĞ°Ñ‚Ğ¸ Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ´:
```rust
// ĞšĞ¾Ğ¼Ğ¿Ñ–Ğ»ÑÑ‚Ğ¾Ñ€ ĞĞ• Ğ´Ğ¾Ğ·Ğ²Ğ¾Ğ»Ğ¸Ñ‚ÑŒ:
- Data races (multiple threads writing to same data)
- Undefined behavior
- Use-after-free

// Ğ¦Ğµ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ rollback, Ğ´Ğµ Ğ¼Ğ°Ğ»Ñ– Ğ²Ñ–Ğ´Ğ¼Ñ–Ğ½Ğ½Ğ¾ÑÑ‚Ñ– = desync
```

#### 1.3. Memory safety = ÑÑ‚Ğ°Ğ±Ñ–Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ¼ÑƒĞ»ÑŒÑ‚Ğ¸Ğ¿Ğ»ĞµÑ”Ñ€
Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ°: 70% crashes Ğ² C++ multiplayer games = memory bugs.
Rust Ğ¿Ñ€Ğ°ĞºÑ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ²Ğ¸ĞºĞ»ÑÑ‡Ğ°Ñ” Ñ†Ğµ **Ğ½Ğ° ĞµÑ‚Ğ°Ğ¿Ñ– ĞºĞ¾Ğ¼Ğ¿Ñ–Ğ»ÑÑ†Ñ–Ñ—**.

#### 1.4. ĞŸÑ€Ğ¾Ğ´ÑƒĞºÑ‚Ğ¸Ğ²Ğ½Ñ–ÑÑ‚ÑŒ
- Zero-cost abstractions
- ĞĞµĞ¼Ğ°Ñ” Garbage Collection Ğ¿Ğ°uz
- SIMD Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ñ–Ğ·Ğ°Ñ†Ñ–Ñ— (Ğ´Ğ»Ñ batch updates)
- Benchmark: 98-100% ÑˆĞ²Ğ¸Ğ´ĞºĞ¾ÑÑ‚Ñ– C++

### ĞĞµĞ´Ğ¾Ğ»Ñ–ĞºĞ¸ Rust (Ñ‚Ğ° ÑĞº Ñ—Ñ… Ğ¿Ğ¾Ğ¼'ÑĞºÑˆĞ¸Ñ‚Ğ¸):

**1. ĞšÑ€Ğ¸Ğ²Ğ° Ğ½Ğ°Ğ²Ñ‡Ğ°Ğ½Ğ½Ñ**
- *Ğ Ñ–ÑˆĞµĞ½Ğ½Ñ:* ĞŸĞ¾Ñ‡Ğ°Ñ‚Ğ¸ Ğ· Bevy Ñ‚ÑƒÑ‚Ğ¾Ñ€Ñ–Ğ°Ğ»Ñ–Ğ² (Bevy Ğ¿Ñ€Ğ¾ÑÑ‚Ñ–ÑˆĞ¸Ğ¹ Ğ·Ğ° Ñ‡Ğ¸ÑÑ‚Ğ¸Ğ¹ Rust)
- *Ğ§Ğ°Ñ:* 2-3 Ñ‚Ğ¸Ğ¶Ğ½Ñ– Ğ´Ğ»Ñ basics, 1-2 Ğ¼Ñ–ÑÑÑ†Ñ– Ğ´Ğ»Ñ Ğ²Ğ¿ĞµĞ²Ğ½ĞµĞ½Ğ¾ÑÑ‚Ñ–

**2. Compilation time**
- *Ğ Ñ–ÑˆĞµĞ½Ğ½Ñ:* `sccache`, incremental compilation, hot reloading Ğ² Bevy
- *Ğ ĞµĞ°Ğ»ÑŒĞ½Ñ–ÑÑ‚ÑŒ:* Full rebuild 30-60 ÑĞµĞº (vs 10-20 ÑĞµĞº C++), incremental 2-5 ÑĞµĞº

**3. ĞœĞµĞ½ÑˆĞµ Ñ‚ÑƒÑ‚Ğ¾Ñ€Ñ–Ğ°Ğ»Ñ–Ğ² Ğ´Ğ»Ñ melee combat**
- *Ğ Ñ–ÑˆĞµĞ½Ğ½Ñ:* Fighting game Ñ‚ÑƒÑ‚Ğ¾Ñ€Ñ–Ğ°Ğ»Ğ¸ (Ğ¼ĞµÑ…Ğ°Ğ½Ñ–ĞºĞ¸ ÑÑ…Ğ¾Ğ¶Ñ–)
- *ĞŸÑ€Ğ¸ĞºĞ»Ğ°Ğ´:* Kataster (open-source fighting game Ğ½Ğ° Bevy)

---

## 2. ĞŸĞ¾Ñ€Ñ–Ğ²Ğ½ÑĞ½Ğ½Ñ Ğ· C++

| ĞÑĞ¿ĞµĞºÑ‚ | Rust | C++ | ĞŸĞµÑ€ĞµĞ¼Ğ¾Ğ¶ĞµÑ†ÑŒ |
|--------|------|-----|-----------|
| **Rollback netcode** | ggrs (excellent) | GGPO (dated) | **Rust** |
| **Ğ”ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ñ–Ğ·Ğ¼** | Ğ“Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ ĞºĞ¾Ğ¼Ğ¿Ñ–Ğ»ÑÑ‚Ğ¾Ñ€Ğ¾Ğ¼ | Manual ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ | **Rust** |
| **Memory safety** | Compile-time checks | Runtime crashes | **Rust** |
| **Raw performance** | 98-100% | 100% | ĞÑ–Ñ‡Ğ¸Ñ |
| **Compile time** | ĞŸĞ¾Ğ²Ñ–Ğ»ÑŒĞ½Ğ° | Ğ¡ĞµÑ€ĞµĞ´Ğ½Ñ | C++ |
| **Dev speed** | Ğ¨Ğ²Ğ¸Ğ´ĞºĞ° (Ğ¿Ñ–ÑĞ»Ñ Ğ½Ğ°Ğ²Ñ‡Ğ°Ğ½Ğ½Ñ) | ĞŸĞ¾Ğ²Ñ–Ğ»ÑŒĞ½Ğ° (debugging) | **Rust** |
| **Ğ•ĞºĞ¾ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° (Ğ·Ğ°Ğ³Ğ°Ğ»ÑŒĞ½Ğ°)** | Ğ—Ñ€Ğ¾ÑÑ‚Ğ°ÑÑ‡Ğ° | Ğ’ĞµĞ»Ğ¸ĞºĞ° | C++ |
| **Ğ•ĞºĞ¾ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° (netcode)** | Modern | Legacy | **Rust** |
| **Cross-platform** | Ğ’Ñ–Ğ´Ğ¼Ñ–Ğ½Ğ½Ğ° | Ğ¥Ğ¾Ñ€Ğ¾ÑˆĞ° | **Rust** |
| **Learning curve** | Steep | Medium | C++ |

**ĞšĞ¾Ğ»Ğ¸ Ğ¾Ğ±Ğ¸Ñ€Ğ°Ñ‚Ğ¸ C++:**
- ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ²Ğ¶Ğµ ĞµĞºÑĞ¿ĞµÑ€Ñ‚Ğ½Ğ° Ğ² C++
- Ğ’Ğ¸ĞºĞ¾Ñ€Ğ¸ÑÑ‚Ğ¾Ğ²ÑƒÑ”Ñ‚ÑŒÑÑ Unreal Engine
- ĞŸĞ¾Ñ‚Ñ€Ñ–Ğ±Ğ½Ñ– Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ– 2% performance (Ğ½ĞµÑ€ĞµĞ°Ğ»Ñ–ÑÑ‚Ğ¸Ñ‡Ğ½Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ñ‚Ğ¾Ñ‚Ğ¸Ğ¿Ñƒ)

**ĞĞ°Ñˆ Ğ²Ğ¸Ğ¿Ğ°Ğ´Ğ¾Ğº:** Rust Ğ¿ĞµÑ€ĞµĞ¼Ğ°Ğ³Ğ°Ñ” Ğ² 7/10 ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¸Ñ… Ğ°ÑĞ¿ĞµĞºÑ‚Ğ°Ñ….

---

## 3. ĞÑ€Ñ…Ñ–Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Ğ¼ÑƒĞ»ÑŒÑ‚Ğ¸Ğ¿Ğ»ĞµÑ”Ñ€Ğ°

### 3.1. Ğ§Ğ¾Ğ¼Ñƒ Rollback, Ğ° Ğ½Ğµ Delay-based?

**Ğ’Ğ°Ñˆ GDD ĞºĞ°Ğ¶Ğµ:**
> "ĞœĞµÑ‡ Ğ²ĞµĞ´Ğµ Ñ€ÑƒĞºÑƒ, Ğ½Ğµ Ğ°Ğ½Ñ–Ğ¼Ğ°Ñ†Ñ–Ñ Ğ²ĞµĞ´Ğµ Ğ³Ñ€Ğ°Ğ²Ñ†Ñ"
> "Low animation commitment"

**Delay-based netcode:**
```
Input â†’ Wait 150ms â†’ Server confirms â†’ Action
```
âŒ Ğ¦Ğµ **Ğ²Ğ±Ğ¸Ğ²Ğ°Ñ”** responsive feel!

**Rollback netcode:**
```
Input â†’ Instant local action â†’ Rollback if needed
```
âœ… Ğ—Ğ±ĞµÑ€Ñ–Ğ³Ğ°Ñ” fluid combat!

**ĞŸÑ€Ğ¸ĞºĞ»Ğ°Ğ´Ğ¸:**
- Fighting games (Street Fighter V, Guilty Gear Strive) = rollback
- Souls-like (Dark Souls, Elden Ring) = delay-based (OK Ğ´Ğ»Ñ slow combat)
- For Honor = hybrid (Ğ¿Ñ€Ğ°Ñ†ÑÑ”, Ğ°Ğ»Ğµ laggy)

### 3.2. Ğ¢Ñ€Ğ¸Ñ„Ğ°Ğ·Ğ½Ğ¸Ğ¹ Ğ¿Ğ»Ğ°Ğ½ Ñ€Ğ¾Ğ·Ñ€Ğ¾Ğ±ĞºĞ¸

#### **Phase 1: Offline (2-3 Ğ¼Ñ–ÑÑÑ†Ñ–)**
**ĞœĞµÑ‚Ğ°:** Ğ”Ğ¾Ğ²ĞµÑÑ‚Ğ¸ core combat feel

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Single Instance    â”‚
â”‚                     â”‚
â”‚  P1 Input â†’ â”      â”‚
â”‚              â†“      â”‚
â”‚        Game Logic   â”‚
â”‚              â†“      â”‚
â”‚  P2 Input â†’ â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Deliverables:**
- [ ] Fluid movement (WASD, sprint, dodge)
- [ ] Directional attacks (8 Ğ½Ğ°Ğ¿Ñ€ÑĞ¼ĞºÑ–Ğ²)
- [ ] Block/parry system
- [ ] Hit detection
- [ ] Stamina system
- [ ] Local 1v1 Ğ½Ğ° Ğ¾Ğ´Ğ½Ğ¾Ğ¼Ñƒ ĞŸĞš

**ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾:** Ğ’ÑÑ Ğ»Ğ¾Ğ³Ñ–ĞºĞ° Ğ”Ğ•Ğ¢Ğ•Ğ ĞœĞ†ĞĞĞ’ĞĞĞ (Ğ³Ğ¾Ñ‚ÑƒÑ”Ğ¼Ğ¾ÑÑŒ Ğ´Ğ¾ rollback)

---

#### **Phase 2: P2P Rollback (1-2 Ğ¼Ñ–ÑÑÑ†Ñ–)**
**ĞœĞµÑ‚Ğ°:** Online 1v1 duels

```
â”Œâ”€ Player 1 PC â”€â”         â”Œâ”€ Player 2 PC â”€â”
â”‚ Game Instance â”‚â—„â”€â”€â”€UDPâ”€â”€â–ºâ”‚ Game Instance â”‚
â”‚ Frame: 1000   â”‚         â”‚ Frame: 1000   â”‚
â”‚               â”‚         â”‚               â”‚
â”‚ Rollback      â”‚         â”‚ Rollback      â”‚
â”‚ Manager       â”‚         â”‚ Manager       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Deliverables:**
- [ ] GGRS integration
- [ ] Input serialization
- [ ] State save/load (snapshots)
- [ ] Lobby system (matchmaking basic)
- [ ] Latency display
- [ ] Rollback Ğ´Ğ¾ 8 frames

**Ğ’Ğ¸ĞºĞ»Ğ¸ĞºĞ¸:**
- Desync debugging (logs + checksums)
- Prediction quality
- Visual artifacts Ğ¿Ñ€Ğ¸ rollback

---

#### **Phase 3: Dedicated Server (Ğ¾Ğ¿Ñ†Ñ–Ğ¹Ğ½Ğ¾, 2-3 Ğ¼Ñ–ÑÑÑ†Ñ–)**
**ĞœĞµÑ‚Ğ°:** Ranked, anti-cheat, tournaments

```
â”Œâ”€ Client 1 â”€â”    â”Œâ”€â”€â”€ Server â”€â”€â”€â”    â”Œâ”€ Client 2 â”€â”
â”‚ Rendering  â”‚â”€â”€â”€â–ºâ”‚ Authoritativeâ”‚â—„â”€â”€â”€â”‚ Rendering  â”‚
â”‚ Prediction â”‚â—„â”€â”€â”€â”‚ Game State   â”‚â”€â”€â”€â–ºâ”‚ Prediction â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ Tick: 60Hz   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Deliverables:**
- [ ] Authoritative server
- [ ] Client prediction
- [ ] Lag compensation
- [ ] Cheat detection
- [ ] Replay system
- [ ] Ranked ladder

**ĞŸÑ€Ğ¸Ğ¼Ñ–Ñ‚ĞºĞ°:** Ğ¦Ğµ Ğ´Ğ»Ñ Ğ¼Ğ°Ğ¹Ğ±ÑƒÑ‚Ğ½ÑŒĞ¾Ğ³Ğ¾. Rollback P2P Ğ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ½ÑŒĞ¾ Ğ´Ğ»Ñ ÑƒÑĞ¿Ñ–ÑˆĞ½Ğ¾Ñ— Ğ³Ñ€Ğ¸.

---

### 3.3. Ğ¢ĞµÑ…Ğ½Ñ–Ñ‡Ğ½Ñ– Ğ´ĞµÑ‚Ğ°Ğ»Ñ– Rollback

#### Ğ”ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ñ–Ğ·Ğ¼: Ğ’Ğ¸Ğ¼Ğ¾Ğ³Ğ¸

**1. Fixed-point math:**
```rust
use fixed::types::I32F32; // 32.32 fixed point

struct Transform {
    x: I32F32,  // ĞĞ• f32! Float non-deterministic Ğ½Ğ° Ñ€Ñ–Ğ·Ğ½Ğ¸Ñ… CPU
    y: I32F32,
    rotation: I32F32,
}
```

**2. No random() Ğ² simulation:**
```rust
// âŒ ĞĞ• Ğ¼Ğ¾Ğ¶Ğ½Ğ°:
let damage = base_damage + random(0..10);

// âœ… ĞœĞ¾Ğ¶Ğ½Ğ°:
let damage = base_damage + hash(attacker_id + frame) % 10;
// (Ğ”ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ¾ ÑĞºÑ‰Ğ¾ seed ÑĞ¸Ğ½Ñ…Ñ€Ğ¾Ğ½Ñ–Ğ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹)
```

**3. No system time:**
```rust
// âŒ ĞĞ• Ğ¼Ğ¾Ğ¶Ğ½Ğ°:
let elapsed = SystemTime::now();

// âœ… ĞœĞ¾Ğ¶Ğ½Ğ°:
let elapsed = game_state.frame * FRAME_TIME; // 1/60 sec
```

**4. Deterministic iteration:**
```rust
// âŒ ĞĞ• Ğ¼Ğ¾Ğ¶Ğ½Ğ°:
for entity in query.iter() { }  // ĞŸĞ¾Ñ€ÑĞ´Ğ¾Ğº Ğ½Ğµ Ğ³Ğ°Ñ€Ğ°Ğ½Ñ‚Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹

// âœ… ĞœĞ¾Ğ¶Ğ½Ğ°:
let mut entities: Vec<_> = query.iter().collect();
entities.sort_by_key(|e| e.id);  // Ğ”ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº
for entity in entities { }
```

#### Snapshot System

```rust
use serde::{Serialize, Deserialize};

#[derive(Clone, Serialize, Deserialize)]
struct GameState {
    frame: u32,
    player1: PlayerState,
    player2: PlayerState,
    projectiles: Vec<Projectile>,
    // Ğ’ÑĞµ Ñ‰Ğ¾ Ğ¼Ğ¾Ğ¶Ğµ Ğ·Ğ¼Ñ–Ğ½Ğ¸Ñ‚Ğ¸ÑÑŒ
}

struct SnapshotManager {
    // Circular buffer Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ–Ñ… 60 frames
    snapshots: [Option<GameState>; 60],
    current_frame: u32,
}

impl SnapshotManager {
    fn save(&mut self, state: &GameState) {
        let idx = (state.frame % 60) as usize;
        self.snapshots[idx] = Some(state.clone());
    }

    fn load(&self, frame: u32) -> Option<GameState> {
        let idx = (frame % 60) as usize;
        self.snapshots[idx].clone()
    }

    fn rollback(&self, current: u32, target: u32) -> Option<GameState> {
        assert!(current - target <= 8, "Max rollback 8 frames!");
        self.load(target)
    }
}
```

#### Input Delay Buffer

```rust
struct InputManager {
    // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ– Ñ–Ğ½Ğ¿ÑƒÑ‚Ğ¸ Ğ²Ğ¿ĞµÑ€ĞµĞ´
    local_inputs: VecDeque<Input>,
    // ĞÑ‚Ñ€Ğ¸Ğ¼Ğ°Ğ½Ñ– Ñ–Ğ½Ğ¿ÑƒÑ‚Ğ¸ Ğ²Ñ–Ğ´ Ğ¾Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğ°
    remote_inputs: HashMap<u32, Input>, // frame -> input

    delay_frames: u32, // 2-3 frames
}

impl InputManager {
    fn get_input_for_frame(&self, frame: u32, is_local: bool) -> Input {
        if is_local {
            // Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ğ¸Ğ¹ Ğ³Ñ€Ğ°Ğ²ĞµÑ†ÑŒ Ğ³Ñ€Ğ°Ñ” Ğ½Ğ° frame - delay
            self.local_inputs.get((frame - self.delay_frames) as usize)
                .copied()
                .unwrap_or(Input::default())
        } else {
            // Ğ’Ñ–Ğ´Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğ¹ Ñ–Ğ½Ğ¿ÑƒÑ‚ (Ğ°Ğ±Ğ¾ prediction)
            self.remote_inputs.get(&frame)
                .copied()
                .unwrap_or_else(|| self.predict_input(frame))
        }
    }

    fn predict_input(&self, frame: u32) -> Input {
        // ĞŸÑ€Ğ¾ÑÑ‚Ğ° prediction: ĞºĞ¾Ğ¿Ñ–ÑÑ”Ğ¼Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ½Ğ½Ñ–Ğ¹ Ğ²Ñ–Ğ´Ğ¾Ğ¼Ğ¸Ğ¹ input
        self.remote_inputs.get(&(frame - 1))
            .copied()
            .unwrap_or(Input::default())
    }
}
```

---

## 4. Ğ¢ĞµÑ…Ğ½Ñ–Ñ‡Ğ½Ğ¸Ğ¹ ÑÑ‚ĞµĞº (Rust)

### 4.1. Core Dependencies

```toml
[dependencies]
# Game Engine
bevy = { version = "0.12", features = ["dynamic_linking"] }

# Networking & Rollback
ggrs = "0.10"              # Rollback netcode library
bevy_ggrs = "0.15"         # Bevy integration for GGRS
renet = "0.0.15"           # Reliable UDP transport
bevy_renet = "0.0.12"      # Bevy integration for renet

# Math & Physics
glam = "0.24"              # Math library (Ğ²ĞµĞºÑ‚Ğ¾Ñ€Ğ½Ğ° Ğ¼Ğ°Ñ‚ĞµĞ¼Ğ°Ñ‚Ğ¸ĞºĞ°)
fixed = "1.24"             # Fixed-point arithmetic
rapier3d = "0.17"          # 3D physics (Ğ¾Ğ¿Ñ†Ñ–Ğ¹Ğ½Ğ¾, Ğ¼Ğ¾Ğ¶Ğ»Ğ¸Ğ²Ğ¾ custom)

# Serialization
serde = { version = "1.0", features = ["derive"] }
bincode = "1.3"            # Ğ‘Ñ–Ğ½Ğ°Ñ€Ğ½Ğ° ÑĞµÑ€Ñ–Ğ°Ğ»Ñ–Ğ·Ğ°Ñ†Ñ–Ñ (ÑˆĞ²Ğ¸Ğ´ĞºĞ°)

# Input
leafwing-input-manager = "0.11"  # Ğ—Ñ€ÑƒÑ‡Ğ½Ğ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ° Ñ–Ğ½Ğ¿ÑƒÑ‚Ñ–Ğ²

# Audio
bevy_kira_audio = "0.18"   # 3D spatial audio

# Dev tools
bevy-inspector-egui = "0.21"  # Runtime inspector
bevy_mod_debugdump = "0.9"    # System graph visualization
```

### 4.2. Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ñƒ

```
arena_combat/
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ .gitignore
â”œâ”€â”€ README.md
â”‚
â”œâ”€â”€ assets/                    # Game resources
â”‚   â”œâ”€â”€ models/
â”‚   â”‚   â”œâ”€â”€ mannequin.glb
â”‚   â”‚   â””â”€â”€ weapons/
â”‚   â”œâ”€â”€ sounds/
â”‚   â”‚   â”œâ”€â”€ sword_swing.ogg
â”‚   â”‚   â””â”€â”€ hit_impact.ogg
â”‚   â”œâ”€â”€ shaders/
â”‚   â””â”€â”€ materials/
â”‚
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs               # Entry point, Bevy app setup
â”‚   â”‚
â”‚   â”œâ”€â”€ lib.rs                # Library root (Ğ´Ğ»Ñ tests)
â”‚   â”‚
â”‚   â”œâ”€â”€ core/                 # âœ… Ğ”Ğ•Ğ¢Ğ•Ğ ĞœĞ†ĞĞĞ’ĞĞĞ Ğ»Ğ¾Ğ³Ñ–ĞºĞ° (NO IO)
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ state.rs          # GameState struct (Clone + Serialize)
â”‚   â”‚   â”œâ”€â”€ input.rs          # Input enum & buffering
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ combat/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ attack.rs     # Attack detection & damage
â”‚   â”‚   â”‚   â”œâ”€â”€ defense.rs    # Block, parry, dodge
â”‚   â”‚   â”‚   â””â”€â”€ stagger.rs    # Hitstun calculation
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ physics/
â”‚   â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ collision.rs  # Hitbox vs hurtbox
â”‚   â”‚   â”‚   â””â”€â”€ movement.rs   # Kinematic movement
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ math/
â”‚   â”‚       â”œâ”€â”€ fixed_point.rs  # Fixed-point wrappers
â”‚   â”‚       â””â”€â”€ deterministic.rs # Ğ”ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ğ¾Ğ²Ğ°Ğ½Ñ– ÑƒÑ‚Ğ¸Ğ»Ñ–Ñ‚Ğ¸
â”‚   â”‚
â”‚   â”œâ”€â”€ systems/              # Bevy ECS systems
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ player/
â”‚   â”‚   â”‚   â”œâ”€â”€ input_system.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ movement_system.rs
â”‚   â”‚   â”‚   â””â”€â”€ animation_system.rs
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ combat/
â”‚   â”‚   â”‚   â”œâ”€â”€ attack_system.rs
â”‚   â”‚   â”‚   â”œâ”€â”€ block_system.rs
â”‚   â”‚   â”‚   â””â”€â”€ damage_system.rs
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ stamina_system.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ network/              # Multiplayer (Phase 2)
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ rollback.rs       # GGRS setup & callbacks
â”‚   â”‚   â”œâ”€â”€ matchmaking.rs    # Lobby, P2P connection
â”‚   â”‚   â”œâ”€â”€ sync.rs           # State synchronization
â”‚   â”‚   â””â”€â”€ packets.rs        # Network message types
â”‚   â”‚
â”‚   â”œâ”€â”€ rendering/            # âŒ ĞĞ• Ğ²Ğ¿Ğ»Ğ¸Ğ²Ğ°Ñ” Ğ½Ğ° simulation
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ mannequin.rs      # 3D model rendering
â”‚   â”‚   â”œâ”€â”€ effects/
â”‚   â”‚   â”‚   â”œâ”€â”€ trails.rs     # Weapon trails
â”‚   â”‚   â”‚   â”œâ”€â”€ particles.rs  # Blood, dust
â”‚   â”‚   â”‚   â””â”€â”€ hitstop.rs    # Screen freeze effect
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ camera.rs         # Camera follow & shake
â”‚   â”‚   â””â”€â”€ ui.rs             # Health bars, stamina
â”‚   â”‚
â”‚   â”œâ”€â”€ audio/
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â””â”€â”€ spatial_sound.rs
â”‚   â”‚
â”‚   â”œâ”€â”€ resources/            # Bevy resources
â”‚   â”‚   â”œâ”€â”€ config.rs         # Game settings
â”‚   â”‚   â””â”€â”€ assets.rs         # Asset handles
â”‚   â”‚
â”‚   â””â”€â”€ plugins/              # Bevy plugins (Ğ¼Ğ¾Ğ´ÑƒĞ»Ñ–)
â”‚       â”œâ”€â”€ game_plugin.rs    # Main game logic
â”‚       â”œâ”€â”€ network_plugin.rs # Networking
â”‚       â””â”€â”€ debug_plugin.rs   # Dev tools
â”‚
â””â”€â”€ tests/
    â”œâ”€â”€ determinism_test.rs   # Ğ¢ĞµÑÑ‚ Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ñ–Ğ·Ğ¼Ñƒ
    â”œâ”€â”€ rollback_test.rs      # Ğ¢ĞµÑÑ‚ rollback
    â””â”€â”€ combat_test.rs        # Unit tests Ğ±Ğ¾Ñ
```

### 4.3. ĞœĞ¾Ğ´ÑƒĞ»ÑŒĞ½Ğ° ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° (Separation of Concerns)

**ĞŸÑ€Ğ¸Ğ½Ñ†Ğ¸Ğ¿:** Ğ”ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ° Ğ»Ğ¾Ğ³Ñ–ĞºĞ° Ğ²Ñ–Ğ´Ğ¾ĞºÑ€ĞµĞ¼Ğ»ĞµĞ½Ğ° Ğ²Ñ–Ğ´ I/O.

```rust
// âŒ ĞŸĞĞ“ĞĞĞ: Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ·Ğ¼Ñ–ÑˆĞ°Ğ½Ğ° Ğ· rendering
fn attack_system(
    mut query: Query<&mut Player>,
    mut gizmos: Gizmos,  // Rendering!
) {
    for mut player in &mut query {
        player.attack();
        gizmos.line(/* draw attack arc */);  // Side effect!
    }
}

// âœ… Ğ”ĞĞ‘Ğ Ğ•: Ğ›Ğ¾Ğ³Ñ–ĞºĞ° Ğ¾ĞºÑ€ĞµĞ¼Ğ¾
// core/combat/attack.rs (Ğ´ĞµÑ‚ĞµÑ€Ğ¼Ñ–Ğ½Ğ¾Ğ²Ğ°Ğ½Ğ°)
pub fn calculate_attack(state: &GameState, input: Input) -> AttackResult {
    // Ğ§Ğ¸ÑÑ‚Ğ° Ñ„ÑƒĞ½ĞºÑ†Ñ–Ñ, NO side effects
}

// systems/combat/attack_system.rs (Bevy)
fn attack_system(
    mut game_state: ResMut<GameState>,
    inputs: Res<InputBuffer>,
) {
    let result = calculate_attack(&game_state, inputs.current());
    game_state.apply(result);
}

// rendering/effects/trails.rs (Ğ²Ñ–Ğ·ÑƒĞ°Ğ»ÑŒĞ½Ğµ)
fn render_attack_trails(
    query: Query<&AttackState>,
    mut gizmos: Gizmos,
) {
    for attack in &query {
        if attack.is_active {
            gizmos.line(/* draw */);
        }
    }
}
```

---

## 5. Development Roadmap

### Milestone 1: Offline Prototype (3 Ğ¼Ñ–ÑÑÑ†Ñ–)
**Deliverable:** Playable local 1v1

**Week 1-2: Setup & Basic Movement**
- [ ] Rust + Bevy project setup
- [ ] Basic 3D scene (arena, mannequins)
- [ ] WASD movement
- [ ] Camera controls
- [ ] Sprint & jump

**Week 3-4: Directional Input**
- [ ] Mouse delta tracking
- [ ] 8-directional input detection
- [ ] Light attack (animation placeholder)
- [ ] Attack direction visualization (debug)

**Week 5-6: Hit Detection**
- [ ] Weapon hitbox (capsule)
- [ ] Player hurtbox (cylinder)
- [ ] Collision detection
- [ ] Basic damage system
- [ ] Health bar UI

**Week 7-8: Combat Mechanics**
- [ ] Heavy attack (charge)
- [ ] Block system (directional)
- [ ] Stamina drain/regen
- [ ] Stagger on hit

**Week 9-10: Advanced Combat**
- [ ] Parry timing window
- [ ] Dodge/roll with i-frames
- [ ] Combo chains (3-hit)
- [ ] Attack cancel (feint)

**Week 11-12: Polish & Feel**
- [ ] Hitstop implementation
- [ ] Camera shake
- [ ] Sound effects
- [ ] Weapon trails (visual)
- [ ] Playtesting & balance

---

### Milestone 2: Online Multiplayer (2 Ğ¼Ñ–ÑÑÑ†Ñ–)
**Deliverable:** P2P netcode Ğ¿Ñ€Ğ°Ñ†ÑÑ”

**Week 13-14: Determinism Prep**
- [ ] Migrate Ğ´Ğ¾ fixed-point math
- [ ] Remove all non-deterministic code
- [ ] Implement GameState serialization
- [ ] Write determinism tests

**Week 15-16: GGRS Integration**
- [ ] Add ggrs + bevy_ggrs dependencies
- [ ] Implement ggrs::GameState trait
- [ ] Local rollback testing (simulated latency)
- [ ] Snapshot save/load

**Week 17-18: Networking**
- [ ] UDP transport (renet)
- [ ] Lobby/matchmaking UI
- [ ] P2P connection establishment
- [ ] Input serialization & send

**Week 19-20: Rollback Testing & Debug**
- [ ] Desync detection (checksums)
- [ ] Rollback visualization (debug)
- [ ] Latency testing (50ms, 100ms, 150ms)
- [ ] Prediction improvement

---

### Milestone 3: Content & Polish (1-2 Ğ¼Ñ–ÑÑÑ†Ñ–)
**Deliverable:** Refined gameplay

- [ ] Multiple weapon types
- [ ] Arena variations
- [ ] More attack moves
- [ ] Advanced combos
- [ ] Ranked matchmaking
- [ ] Replay system
- [ ] Tournament mode

---

## 6. Performance Targets

### Frame Rate
- **Target:** Locked 60 FPS
- **Minimum:** 60 FPS (Ğ´Ñ€Ğ¾Ğ¿Ğ¸ Ğ½ĞµĞ¿Ñ€Ğ¸Ğ¹Ğ½ÑÑ‚Ğ½Ñ– Ğ´Ğ»Ñ fighting game)

### Netcode
- **Input latency:** < 50ms locally
- **Rollback tolerance:** Up to 8 frames (133ms @ 60fps)
- **Ideal ping:** < 50ms
- **Playable ping:** < 150ms
- **Max ping:** 200ms (degraded experience)

### Memory
- **GameState size:** < 10 KB (Ğ´Ğ»Ñ ÑˆĞ²Ğ¸Ğ´ĞºĞ¾Ğ³Ğ¾ clone)
- **Total RAM:** < 500 MB
- **VRAM:** < 1 GB

---

## 7. Testing Strategy

### Unit Tests (Rust)
```rust
#[test]
fn test_determinism() {
    let state1 = GameState::new();
    let state2 = GameState::new();

    let input = Input::Attack(Direction::Top);

    let result1 = simulate(state1, input);
    let result2 = simulate(state2, input);

    assert_eq!(result1, result2, "Same input = same result!");
}

#[test]
fn test_rollback_consistency() {
    let mut state = GameState::new();

    // Simulate 10 frames
    for i in 0..10 {
        state = simulate(state, Input::Idle);
    }
    let checkpoint = state.clone();

    // Rollback to frame 5
    let mut rolled_back = snapshots[5].clone();

    // Re-simulate 5->10
    for i in 5..10 {
        rolled_back = simulate(rolled_back, Input::Idle);
    }

    assert_eq!(checkpoint, rolled_back, "Rollback consistency!");
}
```

### Integration Tests
- Local multiplayer (split-screen)
- Simulated network latency
- Packet loss scenarios

### Playtesting Metrics
- Average match duration
- Parry success rate (should be 10-20%)
- Attack diversity (all 8 directions used?)
- Player retention

---

## 8. Risks & Mitigation

### Risk 1: Rust Learning Curve
**Impact:** Medium
**Probability:** High
**Mitigation:**
- Start Ğ· Bevy Ñ‚ÑƒÑ‚Ğ¾Ñ€Ñ–Ğ°Ğ»Ñ–Ğ²
- Use ChatGPT/Claude Ğ´Ğ»Ñ ĞºĞ¾Ğ´ review
- Ğ¡Ğ¿Ñ–Ğ»ÑŒĞ½Ğ¾Ñ‚Ğ° Bevy Ğ´ÑƒĞ¶Ğµ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ğ° (Discord)

### Risk 2: Desync Issues
**Impact:** Critical
**Probability:** Medium
**Mitigation:**
- Frequent determinism tests
- Comprehensive logging
- Checksum validation ĞºĞ¾Ğ¶ĞµĞ½ frame
- Community playtest early

### Risk 3: Feel vs Netcode Trade-off
**Impact:** High
**Probability:** Medium
**Mitigation:**
- Playtest Ğ· Ñ€Ñ–Ğ·Ğ½Ğ¸Ğ¼Ğ¸ input delay (2f, 3f, 4f)
- Adaptive delay based on connection
- Rollback Ğ´Ğ¾ 8 frames maximum

### Risk 4: Scope Creep
**Impact:** Medium
**Probability:** High
**Mitigation:**
- Stick to GDD phases strictly
- No new features Ğ´Ğ¾ Phase 1 complete
- Weekly milestone reviews

---

## 9. Decision Summary

### âœ… Final Tech Stack:

| Component | Technology | Rationale |
|-----------|-----------|-----------|
| Language | **Rust** | Memory safety, determinism, ggrs |
| Engine | **Bevy 0.12** | ECS, active community, fast iteration |
| Netcode | **GGRS** | Best rollback library, Bevy integration |
| Transport | **Renet** | Reliable UDP, Bevy integration |
| Physics | **Custom + Rapier** | Simple collision, potential for complex |
| Math | **Fixed-point (fixed crate)** | Deterministic cross-platform |
| Audio | **bevy_kira_audio** | Spatial 3D sound |
| Rendering | **Bevy (wgpu)** | Modern, cross-platform |

### ğŸ“‹ Next Steps:

1. **Setup Rust & Bevy** (1 day)
   - Install Rust (`rustup`)
   - Create new Bevy project
   - Verify compilation & examples

2. **Create Project Structure** (1 day)
   - Implement folder structure (above)
   - Setup Git repo
   - Configure .gitignore

3. **Basic Scene** (2-3 days)
   - Render arena
   - Spawn 2 mannequins
   - Basic camera

4. **Start Milestone 1** (see roadmap)

---

## 10. Ğ”Ğ¾Ğ´Ğ°Ñ‚ĞºĞ¾Ğ²Ñ– Ñ€ĞµÑÑƒÑ€ÑĞ¸

### Learning Rust for Games:
- **Bevy Book:** https://bevyengine.org/learn/book/
- **Rust Book:** https://doc.rust-lang.org/book/
- **Bevy Cheatbook:** https://bevy-cheatbook.github.io/

### Rollback Netcode:
- **GGRS Examples:** https://github.com/gschup/ggrs
- **Netcode Explained:** https://ki.infil.net/w02-netcode.html
- **Kataster (example game):** https://github.com/gschup/kataster

### Fighting Game Mechanics:
- **Fantasy Strike Blog:** (design principles)
- **Core-A Gaming YouTube:** (mechanics breakdowns)

### Bevy Community:
- **Discord:** https://discord.gg/bevy
- **Reddit:** r/bevy
- **Examples Repo:** https://github.com/bevyengine/bevy/tree/main/examples

---

**Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ ÑÑ‚Ğ²Ğ¾Ñ€ĞµĞ½Ğ¾:** 2025-12-11
**Ğ’ĞµÑ€ÑÑ–Ñ:** 1.0
**ĞĞ²Ñ‚Ğ¾Ñ€:** Technical Decision Document Ğ´Ğ»Ñ Arena Combat Prototype
